import unittest
import csv
import os
import pickle
import pandas as pd
from io import StringIO
from pMPO import pMPOBuilder

########################################################################################################################
########################################################################################################################

# The DataFrame with the reference data used in the original model building
REFERENCE_DATAFRAME = os.path.join(os.path.join(os.path.dirname(__file__), 'assets'), 'CNS_pMPO.df.pkl')

# The refrence pMPO values for each molecule in Hakan's paper
REFERENCE_CNS_PMPO_VALUES = {
    'Abacavir': 0.44,
    'Abiraterone': 0.75,
    'Acebutolol': 0.49,
    'Acetaminophen': 0.61,
    'Acetazolamide': 0.33,
    'Acetohexamide': 0.51,
    'Acetophenazine': 0.9,
    'Acetyldigitoxin': 0.1,
    'Acitretin': 0.85,
    'Acrivastine': 0.97,
    'Acyclovir': 0.19,
    'Adefovir': 0.2,
    'Afatinib': 0.52,
    'Albendazole': 0.73,
    'Albuterol': 0.39,
    'Alendronate': 0.2,
    'Alfuzosin': 0.41,
    'Aliskiren': 0.18,
    'Allopurinol': 0.48,
    'Almotriptan': 0.92,
    'Alogliptin': 0.66,
    'Alosetron': 0.96,
    'Alprazolam': 0.74,
    'Alprenolol': 0.8,
    'Altretamine': 0.77,
    'Alvimopan': 0.44,
    'Amantadine': 0.65,
    'Ambenonium': 0.48,
    'Ambrisentan': 0.69,
    'Amiloride': 0.23,
    'Aminocaproic acid': 0.54,
    'Aminoglutethimide': 0.66,
    'Aminosalicylic acid': 0.26,
    'Amitriptyline': 0.58,
    'Amlodipine': 0.52,
    'Amoxapine': 0.95,
    'Amoxicillin': 0.24,
    'Amphetamine': 0.66,
    'Amprenavir': 0.1,
    'Anagrelide': 0.86,
    'Anastrozole': 0.63,
    'Anileridine': 0.97,
    'Aniracetam': 0.67,
    'Anisindione': 0.7,
    'Anisotropine': 0.62,
    'Apixaban': 0.44,
    'Apomorphine': 0.84,
    'Aprepitant': 0.46,
    'Aripiprazole': 0.78,
    'Armodafinil': 0.85,
    'Aspirin': 0.65,
    'Astemizole': 0.79,
    'Atazanavir': 0.06,
    'Atenolol': 0.44,
    'Atomoxetine': 0.78,
    'Atorvastatin': 0.15,
    'Atovaquone': 0.8,
    'Atropine': 0.88,
    'Avanafil': 0.24,
    'Axitinib': 0.59,
    'Azatadine': 0.65,
    'Azathioprine': 0.54,
    'Azilsartan': 0.34,
    'Azithromycin': 0.24,
    'Baclofen': 0.66,
    'Balsalazide': 0.15,
    'Bedaquiline': 0.71,
    'Benazepril': 0.43,
    'Bendroflumethiazide': 0.24,
    'Bentiromide': 0.22,
    'Benzphetamine': 0.56,
    'Benztropine': 0.62,
    'Bepridil': 0.59,
    'Betamethasone': 0.35,
    'Betaxolol': 0.83,
    'Bethanechol': 0.65,
    'Bethanidine': 0.57,
    'Bexarotene': 0.72,
    'Bicalutamide': 0.29,
    'Biperiden': 0.85,
    'Bisoprolol': 0.79,
    'Boceprevir': 0.14,
    'Bosentan': 0.2,
    'Bosutinib': 0.6,
    'Bromazepam': 0.88,
    'Bromocriptine': 0.17,
    'Bromodiphenhydramine': 0.64,
    'Brompheniramine': 0.68,
    'Buclizine': 0.42,
    'Budesonide': 0.41,
    'Budipine': 0.59,
    'Bufuralol': 0.82,
    'Bumetanide': 0.27,
    'Buprenorphine': 0.72,
    'Bupropion': 0.84,
    'Buspirone': 0.72,
    'Busulfan': 0.48,
    'Butabarbital': 0.59,
    'Cabergoline': 0.64,
    'Cabozantinib': 0.36,
    'Caffeine': 0.62,
    'Canagliflozin': 0.2,
    'Capecitabine': 0.23,
    'Carbamazepine': 0.83,
    'Carbenicillin': 0.15,
    'Carbidopa': 0.26,
    'Carbinoxamine': 0.76,
    'Carglumic acid': 0.08,
    'Carisoprodol': 0.53,
    'Carprofen': 0.75,
    'Carteolol': 0.58,
    'Carvedilol': 0.55,
    'Cefaclor': 0.27,
    'Cefdinir': 0.1,
    'Cefditoren': 0.06,
    'Cefpodoxime': 0.1,
    'Cefuroxime': 0.1,
    'Celecoxib': 0.65,
    'Ceritinib': 0.27,
    'Cerivastatin': 0.3,
    'Cetirizine': 0.87,
    'Cevimeline': 0.5,
    'Chenodiol': 0.46,
    'Chlophedianol': 0.85,
    'Chlorambucil': 0.87,
    'Chloramphenicol': 0.32,
    'Chlordiazepoxide': 0.88,
    'Chlormezanone': 0.73,
    'Chloroquine': 0.85,
    'Chlorotrianisene': 0.5,
    'Chlorphenesin carbamate': 0.58,
    'Chlorphentermine': 0.75,
    'Chlorpromazine': 0.59,
    'Chlorpropamide': 0.62,
    'Chlorprothixene': 0.54,
    'Chlorthalidone': 0.26,
    'Chlorzoxazone': 0.75,
    'Cilostazol': 0.68,
    'Cimetidine': 0.47,
    'Cinacalcet': 0.7,
    'Cinoxacin': 0.58,
    'Ciprofloxacin': 0.68,
    'Cisapride': 0.56,
    'Citalopram': 0.78,
    'Clavulanate': 0.37,
    'Clemastine': 0.6,
    'Clidinium': 0.85,
    'Clindamycin': 0.35,
    'Clobazam': 0.74,
    'Clofazimine': 0.74,
    'Clofibrate': 0.65,
    'Clomiphene': 0.47,
    'Clomipramine': 0.58,
    'Clonazepam': 0.69,
    'Clonidine': 0.77,
    'Cloxacillin': 0.27,
    'Clozapine': 0.91,
    'Cobicistat': 0.18,
    'Colchicine': 0.65,
    'Crizotinib': 0.61,
    'Cromolyn': 0.07,
    'Cyclacillin': 0.32,
    'Cyclophosphamide': 0.84,
    'Cycloserine': 0.55,
    'Cysteamine': 0.48,
    'Dabrafenib': 0.3,
    'Danazol': 0.78,
    'Dantrolene': 0.56,
    'Dapagliflozin': 0.21,
    'Dapsone': 0.54,
    'Darifenacin': 0.88,
    'Dasatinib': 0.31,
    'Deferasirox': 0.29,
    'Delavirdine': 0.22,
    'Demeclocycline': 0.09,
    'Desloratadine': 0.78,
    'Desogestrel': 0.62,
    'Desvenlafaxine': 0.81,
    'Dexlansoprazole': 0.79,
    'Dexmethylphenidate': 0.88,
    'Dextromethorphan': 0.65,
    'Diazoxide': 0.82,
    'Dichlorphenamide': 0.43,
    'Diclofenac': 0.75,
    'Dicumarol': 0.5,
    'Dicyclomine': 0.71,
    'Didanosine': 0.44,
    'Diethylcarbamazine': 0.68,
    'Diethylpropion': 0.66,
    'Difenoxin': 0.85,
    'Diflunisal': 0.72,
    'Dihydrocodeine': 0.95,
    'Diltiazem': 0.77,
    'Dimethyl fumarate': 0.62,
    'Diphemanil': 0.48,
    'Diphenylpyraline': 0.63,
    'Dipyridamole': 0.16,
    'Dirithromycin': 0.24,
    'Disopyramide': 0.91,
    'Disulfiram': 0.47,
    'Dofetilide': 0.47,
    'Dolasetron': 0.92,
    'Dolutegravir': 0.29,
    'Domperidone': 0.67,
    'Donepezil': 0.77,
    'Doxazosin': 0.54,
    'Doxercalciferol': 0.54,
    'Dronabinol': 0.67,
    'Dronedarone': 0.52,
    'Drospirenone': 0.69,
    'Duloxetine': 0.82,
    'Dutasteride': 0.49,
    'Dydrogesterone': 0.66,
    'Dyphylline': 0.4,
    'Edoxaban': 0.24,
    'Efavirenz': 0.76,
    'Eletriptan': 0.87,
    'Eliglustat': 0.71,
    'Eltrombopag': 0.24,
    'Empagliflozin': 0.18,
    'Emtricitabine': 0.48,
    'Enalapril': 0.45,
    'Entacapone': 0.4,
    'Entecavir': 0.22,
    'Enzalutamide': 0.65,
    'Eplerenone': 0.52,
    'Eprosartan': 0.56,
    'Erlotinib': 0.77,
    'Estradiol': 0.66,
    'Estramustine': 0.68,
    'Eszopiclone': 0.51,
    'Ethacrynic acid': 0.79,
    'Ethambutol': 0.49,
    'Ethchlorvynol': 0.62,
    'Ethinamate': 0.78,
    'Ethionamide': 0.77,
    'Ethopropazine': 0.57,
    'Ethosuximide': 0.73,
    'Ethotoin': 0.8,
    'Ethoxzolamide': 0.71,
    'Ethylestrenol': 0.61,
    'Ethynodiol diacetate': 0.68,
    'Etodolac': 0.71,
    'Etoposide': 0.12,
    'Etravirine': 0.28,
    'Ezetimibe': 0.64,
    'Ezogabine': 0.56,
    'Famotidine': 0.31,
    'Febuxostat': 0.73,
    'Felbamate': 0.44,
    'Felodipine': 0.71,
    'Fenofibrate': 0.64,
    'Fenoprofen': 0.83,
    'Fentanyl': 0.72,
    'Fesoterodine': 0.87,
    'Fexofenadine': 0.44,
    'Finasteride': 0.68,
    'Fingolimod': 0.69,
    'Flavoxate': 0.74,
    'Flecainide': 0.74,
    'Flibanserin': 0.86,
    'Fluconazole': 0.71,
    'Flucytosine': 0.46,
    'Fludarabine': 0.22,
    'Fluoxetine': 0.82,
    'Fluoxymesterone': 0.74,
    'Flurazepam': 0.75,
    'Flurbiprofen': 0.81,
    'Fluvastatin': 0.38,
    'Fluvoxamine': 0.96,
    'Fosfomycin': 0.37,
    'Fosinopril': 0.4,
    'Frovatriptan': 0.49,
    'Furazolidone': 0.38,
    'Furosemide': 0.27,
    'Gabapentin': 0.61,
    'Galantamine': 0.97,
    'Gatifloxacin': 0.59,
    'Gefitinib': 0.77,
    'Gemfibrozil': 0.86,
    'Gemifloxacin': 0.38,
    'Glimepiride': 0.17,
    'Glipizide': 0.16,
    'Glyburide': 0.2,
    'Glycopyrrolate': 0.85,
    'Granisetron': 0.85,
    'Guaifenesin': 0.65,
    'Guanabenz': 0.72,
    'Guanadrel': 0.46,
    'Guanethidine': 0.55,
    'Guanfacine': 0.63,
    'Halazepam': 0.62,
    'Halofantrine': 0.59,
    'Haloperidol': 0.93,
    'Hetacillin': 0.45,
    'Hexocyclium': 0.78,
    'Hydralazine': 0.69,
    'Hydrocortisone': 0.37,
    'Hydroxyzine': 0.92,
    'Ibandronate': 0.25,
    'Ibrutinib': 0.53,
    'Ibuprofen': 0.77,
    'Idelalisib': 0.43,
    'Iloperidone': 0.73,
    'Imatinib': 0.55,
    'Indapamide': 0.51,
    'Indinavir': 0.22,
    'Indomethacin': 0.75,
    'Irbesartan': 0.6,
    'Isocarboxazid': 0.67,
    'Isoniazid': 0.52,
    'Isopropamide': 0.73,
    'Isotretinoin': 0.78,
    'Isradipine': 0.53,
    'Itraconazole': 0.36,
    'Ivacaftor': 0.34,
    'Ketoconazole': 0.61,
    'Ketoprofen': 0.8,
    'Ketorolac': 0.77,
    'Labetalol': 0.44,
    'Lacosamide': 0.67,
    'Lactulose': 0.15,
    'Lamotrigine': 0.53,
    'Lapatinib': 0.32,
    'Lenalidomide': 0.43,
    'Lenvatinib': 0.24,
    'Letrozole': 0.63,
    'Levamisole': 0.54,
    'Levetiracetam': 0.68,
    'Levodopa': 0.26,
    'Levofloxacin': 0.78,
    'Levomepromazine': 0.65,
    'Levomethadyl': 0.72,
    'Levomilnacipran': 0.82,
    'Levopropoxyphene': 0.72,
    'Lidocaine': 0.9,
    'Linagliptin': 0.47,
    'Linezolid': 0.83,
    'Lisinopril': 0.18,
    'Lofexidine': 0.9,
    'Lomitapide': 0.57,
    'Lomustine': 0.81,
    'Loperamide': 0.81,
    'Lopinavir': 0.03,
    'Loracarbef': 0.28,
    'Loratadine': 0.61,
    'Lorazepam': 0.73,
    'Lorcainide': 0.67,
    'Lorcaserin': 0.65,
    'Losartan': 0.48,
    'Lovastatin': 0.66,
    'Lubiprostone': 0.51,
    'Lurasidone': 0.68,
    'Macitentan': 0.29,
    'Maprotiline': 0.73,
    'Maraviroc': 0.77,
    'Mazindol': 0.77,
    'Mecamylamine': 0.57,
    'Medroxyprogesterone acetate': 0.63,
    'Mefenamic acid': 0.72,
    'Mefloquine': 0.8,
    'Meloxicam': 0.44,
    'Melphalan': 0.73,
    'Memantine': 0.7,
    'Mepenzolate': 0.86,
    'Meperidine': 0.77,
    'Mercaptopurine': 0.68,
    'Mesalamine': 0.3,
    'Mesna': 0.63,
    'Mesoridazine': 0.68,
    'Metaproterenol': 0.46,
    'Metaxalone': 0.82,
    'Metergoline': 0.84,
    'Metformin': 0.17,
    'Methamphetamine': 0.56,
    'Methantheline': 0.61,
    'Metharbital': 0.75,
    'Methazolamide': 0.51,
    'Methdilazine': 0.59,
    'Methenamine': 0.49,
    'Methimazole': 0.51,
    'Methixene': 0.55,
    'Methocarbamol': 0.49,
    'Methscopolamine': 0.75,
    'Methylergonovine': 0.68,
    'Methyltestosterone': 0.79,
    'Methyprylon': 0.75,
    'Metoclopramide': 0.76,
    'Metolazone': 0.51,
    'Metoprolol': 0.79,
    'Metronidazole': 0.58,
    'Metyrapone': 0.73,
    'Metyrosine': 0.4,
    'Mexiletine': 0.85,
    'Midodrine': 0.43,
    'Mifepristone': 0.74,
    'Miglitol': 0.29,
    'Miltefosine': 0.56,
    'Minaprine': 0.99,
    'Minocycline': 0.09,
    'Minoxidil': 0.25,
    'Mirabegron': 0.35,
    'Mirtazapine': 0.71,
    'Mitotane': 0.39,
    'Moclobemide': 0.94,
    'Molindone': 0.97,
    'Montelukast': 0.44,
    'Moxifloxacin': 0.52,
    'Mycophenolic acid': 0.5,
    'Nabilone': 0.72,
    'Nabumetone': 0.6,
    'Nadolol': 0.48,
    'Nalidixic acid': 0.79,
    'Nalmefene': 0.86,
    'Naloxegol': 0.28,
    'Naproxen': 0.81,
    'Naratriptan': 0.73,
    'Nateglinide': 0.69,
    'Nebivolol': 0.6,
    'Nefazodone': 0.72,
    'Nelfinavir': 0.19,
    'Nemonapride': 0.82,
    'Neostigmine': 0.51,
    'Nevirapine': 0.88,
    'Niacin': 0.67,
    'Nicardipine': 0.47,
    'Nicergoline': 0.66,
    'Niclosamide': 0.42,
    'Nicotine': 0.53,
    'Nifedipine': 0.56,
    'Nilotinib': 0.33,
    'Nilutamide': 0.64,
    'Nintedanib': 0.49,
    'Nitisinone': 0.42,
    'Nizatidine': 0.67,
    'Norgestimate': 0.74,
    'Nortriptyline': 0.72,
    'Noscapine': 0.64,
    'Novobiocin': 0.09,
    'Olaparib': 0.59,
    'Olsalazine': 0.23,
    'Ondansetron': 0.85,
    'Orlistat': 0.47,
    'Oseltamivir': 0.64,
    'Ospemifene': 0.64,
    'Oxamniquine': 0.43,
    'Oxandrolone': 0.85,
    'Oxaprozin': 0.84,
    'Oxprenolol': 0.8,
    'Oxybate': 0.48,
    'Oxybutynin': 0.9,
    'Oxyphenbutazone': 0.83,
    'Oxyphencyclimine': 0.88,
    'Oxyphenonium': 0.78,
    'Palbociclib': 0.44,
    'Paliperidone': 0.74,
    'Palonosetron': 0.71,
    'Panobinostat': 0.58,
    'Pantoprazole': 0.66,
    'Paramethadione': 0.63,
    'Pargyline': 0.48,
    'Paricalcitol': 0.43,
    'Paroxetine': 0.94,
    'Pazopanib': 0.43,
    'Pemoline': 0.72,
    'Penbutolol': 0.83,
    'Penicillamine': 0.42,
    'Pentazocine': 0.84,
    'Pentoxifylline': 0.61,
    'Perampanel': 0.72,
    'Pergolide': 0.79,
    'Perindopril': 0.5,
    'Phenacemide': 0.57,
    'Phenazone': 0.52,
    'Phenazopyridine': 0.49,
    'Phenelzine': 0.69,
    'Phenmetrazine': 0.73,
    'Phenobarbital': 0.61,
    'Phenoxybenzamine': 0.57,
    'Phenprocoumon': 0.87,
    'Phensuximide': 0.62,
    'Phenylephrine': 0.53,
    'Phenylpropanolamine': 0.67,
    'Phenytoin': 0.72,
    'Pilocarpine': 0.73,
    'Pimozide': 0.72,
    'Pinacidil': 0.7,
    'Pioglitazone': 0.86,
    'Pipobroman': 0.71,
    'Pirenzepine': 0.85,
    'Pirfenidone': 0.53,
    'Pitavastatin': 0.35,
    'Ponatinib': 0.77,
    'Pralidoxime': 0.69,
    'Pramipexole': 0.73,
    'Prasugrel': 0.71,
    'Pravastatin': 0.11,
    'Praziquantel': 0.73,
    'Primaquine': 0.74,
    'Probenecid': 0.74,
    'Probucol': 0.47,
    'Procainamide': 0.72,
    'Procarbazine': 0.66,
    'Prochlorperazine': 0.56,
    'Proguanil': 0.46,
    'Propantheline': 0.58,
    'Propofol': 0.58,
    'Propranolol': 0.81,
    'Propylthiouracil': 0.74,
    'Protokylol': 0.46,
    'Pseudoephedrine': 0.61,
    'Pyrazinamide': 0.63,
    'Pyridostigmine': 0.49,
    'Pyrilamine': 0.76,
    'Pyrimethamine': 0.7,
    'Pyrvinium': 0.38,
    'Quetiapine': 0.93,
    'Quinestrol': 0.65,
    'Quinethazone': 0.34,
    'Quinidine': 0.97,
    'Rabeprazole': 0.77,
    'Raloxifene': 0.57,
    'Raltegravir': 0.08,
    'Ramelteon': 0.83,
    'Ranolazine': 0.65,
    'Rasagiline': 0.69,
    'Reboxetine': 0.97,
    'Regorafenib': 0.19,
    'Remifentanil': 0.7,
    'Repaglinide': 0.59,
    'Reserpine': 0.47,
    'Ribavirin': 0.14,
    'Rifaximin': 0.12,
    'Riluzole': 0.84,
    'Rimantadine': 0.7,
    'Rimonabant': 0.66,
    'Riociguat': 0.29,
    'Risedronate': 0.2,
    'Risperidone': 0.77,
    'Ritodrine': 0.57,
    'Ritonavir': 0.03,
    'Rivaroxaban': 0.59,
    'Rivastigmine': 0.77,
    'Rizatriptan': 0.88,
    'Rofecoxib': 0.74,
    'Roflumilast': 0.71,
    'Ropinirole': 0.89,
    'Ropivacaine': 0.91,
    'Rosiglitazone': 0.87,
    'Rosuvastatin': 0.06,
    'Rufinamide': 0.71,
    'Ruxolitinib': 0.73,
    'Sapropterin': 0.23,
    'Saquinavir': 0.16,
    'Saxagliptin': 0.58,
    'Selegiline': 0.53,
    'Sertindole': 0.8,
    'Sertraline': 0.76,
    'Sibutramine': 0.56,
    'Sildenafil': 0.54,
    'Silodosin': 0.35,
    'Simeprevir': 0.25,
    'Sitagliptin': 0.8,
    'Sodium phenylbutyrate': 0.58,
    'Sofosbuvir': 0.16,
    'Sotalol': 0.4,
    'Sparfloxacin': 0.37,
    'Spirapril': 0.39,
    'Spironolactone': 0.63,
    'Stanozolol': 0.66,
    'Stavudine': 0.5,
    'Succimer': 0.31,
    'Sulfacytine': 0.36,
    'Sulfadoxine': 0.35,
    'Sulfameter': 0.4,
    'Sulfamethizole': 0.41,
    'Sulfamethoxazole': 0.43,
    'Sulfaphenazole': 0.54,
    'Sulfasalazine': 0.2,
    'Sulfinpyrazone': 0.63,
    'Sulfoxone': 0.1,
    'Sulindac': 0.83,
    'Sumatriptan': 0.72,
    'Sunitinib': 0.54,
    'Suvorexant': 0.49,
    'Tacrine': 0.87,
    'Tadalafil': 0.73,
    'Talipexole': 0.9,
    'Tamoxifen': 0.52,
    'Tamsulosin': 0.52,
    'Tapentadol': 0.8,
    'Tasimelteon': 0.82,
    'Tedizolid': 0.56,
    'Tegaserod': 0.53,
    'Telaprevir': 0.07,
    'Telithromycin': 0.46,
    'Telmisartan': 0.63,
    'Temozolomide': 0.43,
    'Tenofovir': 0.21,
    'Terbinafine': 0.49,
    'Terguride': 0.82,
    'Teriflunomide': 0.62,
    'Testolactone': 0.74,
    'Tetrabenazine': 0.78,
    'Thiabendazole': 0.8,
    'Thioguanine': 0.4,
    'Thiopental': 0.68,
    'Thiothixene': 0.72,
    'Tiagabine': 0.89,
    'Tianeptine': 0.54,
    'Ticagrelor': 0.15,
    'Ticlopidine': 0.55,
    'Tiludronate': 0.16,
    'Timolol': 0.62,
    'Tinidazole': 0.43,
    'Tiopronin': 0.36,
    'Tipranavir': 0.29,
    'Tizanidine': 0.79,
    'Tocainide': 0.76,
    'Tofacitinib': 0.7,
    'Tolazamide': 0.59,
    'Tolcapone': 0.48,
    'Tolmetin': 0.75,
    'Tolrestat': 0.8,
    'Topotecan': 0.49,
    'Torsemide': 0.41,
    'Tramadol': 0.87,
    'Tranexamic acid': 0.57,
    'Tranylcypromine': 0.73,
    'Trazodone': 0.82,
    'Treprostinil': 0.38,
    'Triamterene': 0.37,
    'Tridihexethyl': 0.63,
    'Trimethobenzamide': 0.86,
    'Trimethoprim': 0.56,
    'Trimipramine': 0.59,
    'Trioxsalen': 0.64,
    'Triprolidine': 0.67,
    'Troglitazone': 0.43,
    'Troleandomycin': 0.37,
    'Tropisetron': 0.94,
    'Trospium': 0.8,
    'Trovafloxacin': 0.45,
    'Uracil mustard': 0.7,
    'Valdecoxib': 0.7,
    'Valproic acid': 0.69,
    'Valsartan': 0.32,
    'Vandetanib': 0.78,
    'Varenicline': 0.79,
    'Vemurafenib': 0.38,
    'Vilazodone': 0.37,
    'Vinpocetine': 0.73,
    'Vismodegib': 0.68,
    'Vorapaxar': 0.56,
    'Voriconazole': 0.75,
    'Vorinostat': 0.48,
    'Vortioxetine': 0.79,
    'Zafirlukast': 0.22,
    'Zaleplon': 0.65,
    'Zidovudine': 0.36,
    'Zileuton': 0.62,
    'Ziprasidone': 0.89,
    'Zolmitriptan': 0.78,
    'Zolpidem': 0.79,
    'Zonisamide': 0.59
 }

# The reference intermediate CSV values from the model building in Hakan's paper
REFERENCE_INTERMEDIATE_VALUES_CSV = """name,p_value,good_mean,good_std,bad_mean,bad_std,good_nsamples,bad_nsamples,cutoff,b,c,z,w
TPSA,1.53302825374e-37,50.7017727635,28.3039124335,86.6483879508,39.3310947469,299,366,65.7447200619,0.151695487107,0.793679783519,0.531479431818,0.333254
HBD,2.6491093047e-25,1.08695652174,0.891691734071,2.03825136612,1.35245625655,299,366,1.46494485092,0.0940054673368,9.51515104848e-05,0.423900227773,0.265798
MW,2.32807969696e-10,304.703053545,94.0468619927,362.423958393,135.961231175,299,366,328.304266431,0.0319893623019,0.829287962918,0.250951625455,0.157354
cLogD_ACD_v15,2.66954664227e-07,1.80861953019,1.93092146089,0.838442630309,2.84658487103,297,366,1.41650379728,0.0208331236351,131996.985929,0.203071818744,0.127332
mbpKa,0.000219929547677,8.07348212768,2.20894961173,7.17077320052,2.65960541699,224,194,7.66390710544,0.0173381729161,1459310.7835,0.185416190602,0.116262
"""

########################################################################################################################
########################################################################################################################


# Transformation of the intermediate CSV values above into something usable
def _read_csv_to_dict(csv_text: str) -> dict:
    data = {}
    csv_io = StringIO(csv_text)
    reader = csv.DictReader(csv_io, delimiter=',')
    for row in reader:
        name = row.pop('name')
        data[name] = row
    return data

REFERENCE_INTERMEDIATE_VALUES = _read_csv_to_dict(REFERENCE_INTERMEDIATE_VALUES_CSV)

########################################################################################################################
########################################################################################################################


class test_suite001_building(unittest.TestCase):

    def setUp(self):
        self.df = pd.read_pickle(REFERENCE_DATAFRAME)

    def test001_builder(self):
        """
        Make sure we can construct a builder
        """
        builder = pMPOBuilder(self.df, good_column='CNS', model_name='CNS pMPO')
        self.assertIsNotNone(builder)

    def test002_get_model(self):
        """
        Make sure we can retrieve a model
        """
        builder = pMPOBuilder(self.df, good_column='CNS', model_name='CNS pMPO')
        model = builder.get_pMPO()
        self.assertIsNotNone(model)


class test_suite002_behavior(unittest.TestCase):

    def setUp(self):
        self.df = pd.read_pickle(REFERENCE_DATAFRAME)
        self.builder = pMPOBuilder(self.df, good_column='CNS', model_name='CNS pMPO', sigmoidal_correction=False)
        self.model = self.builder.get_pMPO()

    def test003_intermediate_statistics(self):
        """
        Check all the intermediate statistics are OK
        """
        stats = self.builder.get_pMPO_statistics()
        for row in stats.iterrows():
            row_data = row[1].to_dict()
            name = row_data.pop('name')
            if name in REFERENCE_INTERMEDIATE_VALUES:
                for attribute_name, attribute_value in row_data.items():
                    if attribute_name in REFERENCE_INTERMEDIATE_VALUES[name]:
                        val = float(REFERENCE_INTERMEDIATE_VALUES[name][attribute_name])
                        self.assertTrue(val - 0.01 <= attribute_value <= val + 0.01,
                                        "{} does not match reference within 0.01 tolerance {} != {}".format(
                                            attribute_name, attribute_value, val))

    def test004_prediction(self):
        for row in self.df.iterrows():
            row_data = row[1].to_dict()
            name = row_data.pop('Drug')
            # Score this molecule
            score = self.model(**row_data)
            # The reference values underwent some heavy rounding so we give ourselves a little more wiggle room
            self.assertTrue(REFERENCE_CNS_PMPO_VALUES[name] - 0.025 <= score <= REFERENCE_CNS_PMPO_VALUES[name] + 0.025,
                            "{} does not score within 0.025 tolerance of reference value {} != {}".format(
                                name, score, REFERENCE_CNS_PMPO_VALUES[name]))

    def test005_pickle(self):
        serialized_model = pickle.dumps(self.model)
        self.assertIsNotNone(serialized_model)
        unserialized_model = pickle.loads(serialized_model)
        self.assertEqual(str(self.model), str(unserialized_model))

    def test006_null_dataframe(self):
        """
        Try building a pMPO with an empty DataFrame
        """
        df = pd.DataFrame()
        with self.assertRaises(AssertionError):
            pMPOBuilder(df, good_column='CNS', model_name='CNS pMPO')

    def test007_invalid_column(self):
        """
        Try building a pMPO with an invalid column
        """
        with self.assertRaises(AssertionError):
            pMPOBuilder(self.df, good_column='I DO NOT EXIST', model_name='CNS pMPO')
